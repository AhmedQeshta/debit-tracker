# ğŸš€ DebitTracker

**DebitTracker** is a premium, offline-first mobile application built with React Native and Expo. It allows users to track personal debts, transactions, and balances with a seamless user experience, even without an internet connection.

## âœ¨ Features

- ğŸ“± **Offline-First Architecture**: Perform all CRUD actions offline; data syncs automatically in the background when a connection is restored.
- ğŸŒ“ **Premium Dark Mode**: A sleek, high-contrast dark interface designed for modern mobile users.
- ğŸ‘¥ **User Management**: Add, search, and manage a list of regular contacts/users.
- ğŸ’¸ **Transaction Tracking**: Easy-to-use transaction entry with a sign toggle (+ / -) to distinguish between money owed and money borrowed.
- ğŸ“Š **Dashboard & Analytics**: Global stats including total users, pending syncs, and aggregate debt balance.
- ğŸ”— **Deep Linking & Navigation**: Built on **Expo Router** for robust file-based navigation.
- ğŸ§  **Persistent State**: Powered by **Zustand** and **AsyncStorage** for fast, reliable data persistence.

## ğŸ› ï¸ Tech Stack

- **Framework**: Expo (SDK 54)
- **Navigation**: Expo Router
- **State Management**: Zustand (with Persist middleware)
- **Persistence**: @react-native-async-storage/async-storage
- **Network Stats**: @react-native-community/netinfo
- **Styling**: React Native StyleSheet (with a centralized theme system)
- **Icons**: Lucide React Native

## ğŸ“‚ Project Structure

```text
app/                 # Expo Router file-based screens
components/          # Reusable UI components (Button, Input, etc.)
store/              # Zustand stores for users, transactions, and sync
services/           # Sync engine, Network monitoring, and Storage services
theme/              # Centralized color palette and spacing tokens
types/              # TypeScript model definitions
```

## ğŸš€ Getting Started

### Prerequisites

- Node.js (v18+)
- npm or yarn
- Expo Go app on your mobile device (for testing)
- Clerk account (for authentication)
- Supabase account (for cloud sync)

### Installation

1. Clone the repository:

   ```bash
   git clone <repository-url>
   cd debit-tracker
   ```

2. Install dependencies:

   ```bash
   npm install
   ```

<<<<<<< HEAD 3. Set up environment variables:

Create a `.env` file in the root directory:

```env
EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY=your_clerk_publishable_key
EXPO_PUBLIC_SUPABASE_URL=your_supabase_url
EXPO_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

4. Configure Clerk JWT Template:
   - Go to your Clerk Dashboard â†’ JWT Templates
   - Create a new JWT template named **"supabase"**
   - Add the following claims:
     - `sub`: `{{user.id}}` (Clerk user ID)
     - `email`: `{{user.primary_email_address}}` (optional)
   - Save the template

5. Set up Supabase Database:
   - Run the migration file: `supabase/migrations/001_create_app_users_and_fix_schema.sql`
   - This creates the `app_users`, `friends`, `transactions`, `budgets`, and `budget_items` tables
   - Enables Row Level Security (RLS) with policies based on `app_users.clerk_id`

6. Start the project:

   ```bash
   npm start
   ```

7. Open on your device:
   - Scan the QR code with the **Expo Go** app (Android) or Camera (iOS).
   - Press `a` for Android Emulator or `i` for iOS Simulator.

## ğŸ“± Asset Requirements

**Important**: The following icon images must be square (equal width and height):

- `./assets/icon.png` - App icon (recommended: 1024x1024)
- `./assets/adaptive-icon.png` - Android adaptive icon foreground (recommended: 1024x1024)

Currently these images are 1115x1073 and need to be resized to square dimensions for Expo validation to pass.

## ğŸ”„ Sync Engine Logic

The app uses a robust offline-first sync pattern:

1. **Offline-First**: All CRUD operations happen locally first (AsyncStorage/Zustand)
2. **Action Queue**: Every create/update/delete action is added to a persistent `SyncQueue`
3. **Sync Gating**: Sync only runs when `syncEnabled=true` and user is signed in
4. **Connectivity Listener**: `NetInfo` monitors network changes
5. **Automatic Re-sync**: When connection is restored and sync is enabled, the `SyncQueue` is processed sequentially
6. **JWT Refresh**: Automatically refreshes expired JWT tokens (PGRST303 errors) and retries failed requests

## ğŸ” Authentication & Data Model

### Clerk â†’ Supabase Integration

- **JWT Template**: Clerk JWT template named "supabase" provides `sub` (Clerk user ID) and optional `email`
- **User Records**: Each Clerk user gets an `app_users` row with:
  - `id`: UUID (primary key, generated by Postgres)
  - `clerk_id`: TEXT (Clerk user ID, unique)
  - `email`, `name`: User profile data
- **Cloud User ID**: The `app_users.id` (UUID) is stored locally as `cloudUserId` and used for all foreign key relationships

### Row Level Security (RLS)

All tables use RLS policies that check:

- `app_users.clerk_id = (auth.jwt() ->> 'sub')` for user records
- `owner_id` belongs to the authenticated user for friends, transactions, budgets, and budget items

### Data Model

- **app_users**: Authenticated app users (linked to Clerk)
- **friends**: User's contacts/friends (owned by app_user via `owner_id`)
- **transactions**: Financial transactions (owned by app_user, linked to friend)
  - `sign`: 1 = add debt, -1 = reduce debt
  - `amount`: Always positive, direction determined by `sign`
- **budgets**: Budget plans (owned by app_user via `owner_id`)
- **budget_items**: Items within budgets (owned by app_user via `owner_id`)

## âš¡ Splash Screen Performance

The app uses a fast, non-blocking splash screen strategy:

1. **Phase 1 (Fast, <300ms)**:
   - Hydrate local stores (Zustand persist)
   - Render router
   - Hide splash immediately

2. **Phase 2 (Async, Non-blocking)**:
   - If `syncEnabled && signedIn && online`:
     - Bind Supabase JWT token
     - Ensure `app_users` record exists
     - Run sync operations

3. **Timeout Fallback**: Splash hides after max 2 seconds regardless of state

# **Key**: Network requests and sync operations never block the splash screen or initial render.

2. Start the app

   ```bash
   npx expo start
   ```

In the output, you'll find options to open the app in a

- [development build](https://docs.expo.dev/develop/development-builds/introduction/)
- [Android emulator](https://docs.expo.dev/workflow/android-studio-emulator/)
- [iOS simulator](https://docs.expo.dev/workflow/ios-simulator/)
- [Expo Go](https://expo.dev/go), a limited sandbox for trying out app development with Expo

You can start developing by editing the files inside the **app** directory. This project uses [file-based routing](https://docs.expo.dev/router/introduction).

## Get a fresh project

When you're ready, run:

```bash
npm run reset-project
```

This command will move the starter code to the **app-example** directory and create a blank **app** directory where you can start developing.

## Learn more

To learn more about developing your project with Expo, look at the following resources:

- [Expo documentation](https://docs.expo.dev/): Learn fundamentals, or go into advanced topics with our [guides](https://docs.expo.dev/guides).
- [Learn Expo tutorial](https://docs.expo.dev/tutorial/introduction/): Follow a step-by-step tutorial where you'll create a project that runs on Android, iOS, and the web.

## Join the community

Join our community of developers creating universal apps.

- [Expo on GitHub](https://github.com/expo/expo): View our open source platform and contribute.
- [Discord community](https://chat.expo.dev): Chat with Expo users and ask questions.
  > > > > > > > ff6d732 (Initial commit)
